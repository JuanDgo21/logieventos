<div class="password-recovery-container">
  <div class="recovery-background">
    <div class="particle particle-1"></div>
    <div class="particle particle-2"></div>
    <div class="particle particle-3"></div>
  </div>

  <div class="recovery-card">
    <div class="brand-section">
      <div class="logo-circle">
        <i class="fas fa-lock"></i>
      </div>
      <h1>Recuperar Contraseña</h1>
      <div class="tagline">Ingresa tu email para restablecer tu contraseña</div>
    </div>

    <!-- Stepper visual -->
    <div class="recovery-stepper">
      <div class="step" [ngClass]="{'active': !emailVerified, 'completed': emailVerified}">
        <div class="step-circle">
          @if (!emailVerified) {
            <span>1</span>
          }
          @if (emailVerified) {
            <i class="fas fa-check"></i>
          }
        </div>
        <div class="step-label">Verificar Email</div>
      </div>
      <div class="step-connector" [ngClass]="{'active': emailVerified}"></div>
      <div class="step" [ngClass]="{'active': emailVerified && !resetSuccess, 'completed': resetSuccess}">
        <div class="step-circle">
          @if (!resetSuccess) {
            <span>2</span>
          }
          @if (resetSuccess) {
            <i class="fas fa-check"></i>
          }
        </div>
        <div class="step-label">Nueva Contraseña</div>
      </div>
    </div>

    <form class="recovery-form" [formGroup]="recoveryForm" (ngSubmit)="emailVerified ? resetPassword() : verifyEmail()">

      <!-- Paso 1: Verificación de email -->
      @if (!emailVerified && !resetSuccess) {
        <div class="form-step">
          <!-- Alerta de error general -->
          @if (errorMessage) {
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-circle"></i> {{ errorMessage }}
            </div>
          }

          <!-- Alerta de advertencia para validación de email -->
          @if (recoveryForm.get('email')?.invalid && recoveryForm.get('email')?.touched) {
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              @if (recoveryForm.get('email')?.errors?.['required']) {
                <span>El email es requerido</span>
              }
              @if (recoveryForm.get('email')?.errors?.['email']) {
                <span>Ingresa un email válido</span>
              }
            </div>
          }

          <div class="input-field">
            <i class="fas fa-envelope"></i>
            <input type="email"
                   formControlName="email"
                   placeholder="Email registrado"
                   [class.invalid]="recoveryForm.get('email')?.invalid && recoveryForm.get('email')?.touched">
          </div>

          <button type="submit" class="btn btn-primary" [disabled]="isLoading || recoveryForm.get('email')?.invalid">
            @if (!isLoading) {
              <span>Continuar</span>
            }
            @if (isLoading) {
              <span>
                <i class="fas fa-spinner fa-spin"></i> Procesando...
              </span>
            }
          </button>

          <div class="back-to-login">
            <a [routerLink]="['/auth/login']">
              <i class="fas fa-arrow-left"></i> Volver al inicio de sesión
            </a>
          </div>
        </div>
      }

      <!-- Paso 2: Restablecer contraseña -->
      @if (emailVerified && !resetSuccess) {
        <div class="form-step">
          <!-- Alerta de éxito con mensaje de verificación -->
          @if (successMessage) {
            <div class="alert alert-success">
              <i class="fas fa-check-circle"></i> {{ successMessage }}
            </div>
          }

          <!-- Campo nueva contraseña -->
          <div class="input-field">
            <i class="fas fa-lock"></i>
            <input 
              [type]="showNewPassword ? 'text' : 'password'"
              formControlName="newPassword"
              placeholder="Nueva contraseña"
              [class.invalid]="recoveryForm.get('newPassword')?.invalid && recoveryForm.get('newPassword')?.touched" />
            <i 
              class="fas {{showNewPassword ? 'fa-eye-slash' : 'fa-eye'}} password-toggle"
              (click)="showNewPassword = !showNewPassword"></i>
          </div>

          <!-- Barra de fuerza de contraseña -->
          @if (recoveryForm.get('newPassword')?.value) {
            <div class="password-strength">
              <div class="strength-bar" [ngClass]="getPasswordStrengthClass()"></div>
              <div class="strength-label">{{ getPasswordStrengthText() }}</div>
            </div>
          }

          <!-- Alerta de error de validación de nueva contraseña -->
          @if (recoveryForm.get('newPassword')?.invalid && recoveryForm.get('newPassword')?.touched) {
            <div class="alert alert-danger">
              @if (recoveryForm.get('newPassword')?.errors?.['required']) {
                <span>
                  <i class="fas fa-exclamation-circle"></i> La contraseña es requerida
                </span>
              }
              @if (recoveryForm.get('newPassword')?.errors?.['minlength']) {
                <span>
                  <i class="fas fa-exclamation-circle"></i> Mínimo 8 caracteres
                </span>
              }
            </div>
          }

          <!-- Campo confirmar contraseña -->
          <div class="input-field">
            <i class="fas fa-lock"></i>
            <input 
              [type]="showConfirmPassword ? 'text' : 'password'"
              formControlName="confirmPassword"
              placeholder="Confirmar contraseña"
              [class.invalid]="(recoveryForm.get('confirmPassword')?.invalid || recoveryForm.hasError('mismatch')) && recoveryForm.get('confirmPassword')?.touched" />
            <i 
              class="fas {{showConfirmPassword ? 'fa-eye-slash' : 'fa-eye'}} password-toggle"
              (click)="showConfirmPassword = !showConfirmPassword"></i>
          </div>

          <!-- Alerta de error si las contraseñas no coinciden -->
          @if (recoveryForm.hasError('mismatch') && recoveryForm.get('confirmPassword')?.touched) {
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-circle"></i> Las contraseñas no coinciden
            </div>
          }

          <!-- Alerta de error general -->
          @if (errorMessage) {
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-circle"></i> {{ errorMessage }}
            </div>
          }

          <button type="submit" class="btn btn-primary" [disabled]="isLoading || recoveryForm.invalid">
            @if (!isLoading) {
              <span>Restablecer contraseña</span>
            }
            @if (isLoading) {
              <span>
                <i class="fas fa-spinner fa-spin"></i> Procesando...
              </span>
            }
          </button>

          <div class="back-to-login">
            <a [routerLink]="['/auth/login']">
              <i class="fas fa-arrow-left"></i> Volver al inicio de sesión
            </a>
          </div>
        </div>
      }

      <!-- Paso 3: Éxito total -->
      @if (resetSuccess) {
        <div class="form-step">
          <div class="success-animation">
            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
              <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
              <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
            <h3>¡Contraseña actualizada!</h3>
            <p>Redirigiendo al login...</p>
          </div>

          <!-- Alerta de éxito final -->
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> Tu contraseña ha sido restablecida exitosamente
          </div>

          <div class="back-to-login">
            <a [routerLink]="['/auth/login']">
              <i class="fas fa-sign-in-alt"></i> Ir al login ahora
            </a>
          </div>
        </div>
      }
    </form>
  </div>
</div>
<div class="recovery-container">
  <div class="card recovery-card">
    <div class="card-header bg-primary text-white">
      <h2 class="text-center mb-0">Recuperar Contraseña</h2>
    </div>
    
    <div class="card-body p-4">
      <!-- Mensajes de estado -->
      @if (errorMessage) {
        <div class="alert alert-danger alert-dismissible fade show">
          <i class="fas fa-exclamation-circle me-2"></i>
          {{ errorMessage }}
          <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
        </div>
      }

      @if (successMessage && !resetSuccess) {
        <div class="alert alert-info alert-dismissible fade show">
          <i class="fas fa-info-circle me-2"></i>
          {{ successMessage }}
        </div>
      }

      @if (resetSuccess) {
        <div class="alert alert-success">
          <i class="fas fa-check-circle me-2"></i>
          {{ successMessage }}
        </div>
      }

      <!-- Formulario -->
      <form [formGroup]="recoveryForm" (ngSubmit)="emailVerified ? resetPassword() : verifyEmail()">
        <!-- Paso 1: Email -->
        @if (!emailVerified) {
          <div class="mb-4">
            <p class="text-muted">Ingresa tu correo electrónico para iniciar el proceso de recuperación.</p>
            
            <div class="form-group mb-3">
              <label for="email" class="form-label">Correo Electrónico</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-envelope"></i>
                </span>
                <input 
                  type="email" 
                  class="form-control" 
                  id="email" 
                  formControlName="email"
                  placeholder="tu@email.com"
                  [class.is-invalid]="recoveryForm.get('email')?.invalid && 
                                    (recoveryForm.get('email')?.dirty || recoveryForm.get('email')?.touched)">
              </div>
              @if (recoveryForm.get('email')?.invalid && 
                  (recoveryForm.get('email')?.dirty || recoveryForm.get('email')?.touched)) {
                <div class="invalid-feedback d-block">
                  @if (recoveryForm.get('email')?.errors?.['required']) {
                    <div><i class="fas fa-info-circle me-1"></i>El email es requerido</div>
                  }
                  @if (recoveryForm.get('email')?.errors?.['email']) {
                    <div><i class="fas fa-info-circle me-1"></i>Ingresa un email válido</div>
                  }
                </div>
              }
            </div>

            <button 
              type="submit" 
              class="btn btn-primary w-100 py-2"
              [disabled]="recoveryForm.get('email')?.invalid || isLoading">
              @if (!isLoading) {
                <i class="fas fa-paper-plane me-2"></i>
                Enviar Instrucciones
              }
              @if (isLoading) {
                <i class="fas fa-spinner fa-spin me-2"></i>
                Procesando...
              }
            </button>
          </div>
        }

        <!-- Paso 2: Nueva contraseña -->
        @if (emailVerified && !resetSuccess) {
          <div class="mb-4">
            <div class="form-group mb-3">
              <label for="newPassword" class="form-label">Nueva Contraseña</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-lock"></i>
                </span>
                <input 
                  type="password" 
                  class="form-control" 
                  id="newPassword" 
                  formControlName="newPassword"
                  placeholder="Mínimo 8 caracteres"
                  [class.is-invalid]="recoveryForm.get('newPassword')?.invalid && 
                                    (recoveryForm.get('newPassword')?.dirty || recoveryForm.get('newPassword')?.touched)">
              </div>
              @if (recoveryForm.get('newPassword')?.invalid && 
                  (recoveryForm.get('newPassword')?.dirty || recoveryForm.get('newPassword')?.touched)) {
                <div class="invalid-feedback d-block">
                  @if (recoveryForm.get('newPassword')?.errors?.['required']) {
                    <div><i class="fas fa-info-circle me-1"></i>La contraseña es requerida</div>
                  }
                  @if (recoveryForm.get('newPassword')?.errors?.['minlength']) {
                    <div><i class="fas fa-info-circle me-1"></i>Mínimo 8 caracteres</div>
                  }
                </div>
              }
            </div>

            <div class="form-group mb-4">
              <label for="confirmPassword" class="form-label">Confirmar Contraseña</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-lock"></i>
                </span>
                <input 
                  type="password" 
                  class="form-control" 
                  id="confirmPassword" 
                  formControlName="confirmPassword"
                  placeholder="Repite tu contraseña"
                  [class.is-invalid]="(recoveryForm.get('confirmPassword')?.invalid || 
                                      recoveryForm.errors?.['mismatch']) && 
                                     (recoveryForm.get('confirmPassword')?.dirty || 
                                      recoveryForm.get('confirmPassword')?.touched)">
              </div>
              @if (recoveryForm.errors?.['mismatch'] && 
                  (recoveryForm.get('confirmPassword')?.dirty || 
                   recoveryForm.get('confirmPassword')?.touched)) {
                <div class="invalid-feedback d-block">
                  <i class="fas fa-info-circle me-1"></i>
                  Las contraseñas no coinciden
                </div>
              }
            </div>

            <button 
              type="submit" 
              class="btn btn-success w-100 py-2"
              [disabled]="recoveryForm.invalid || isLoading">
              @if (!isLoading) {
                <i class="fas fa-save me-2"></i>
                Actualizar Contraseña
              }
              @if (isLoading) {
                <i class="fas fa-spinner fa-spin me-2"></i>
                Procesando...
              }
            </button>
          </div>
        }
      </form>

      <div class="text-center mt-3">
        <a [routerLink]="['/auth/login']" class="text-decoration-none">
          <i class="fas fa-arrow-left me-2"></i>Volver al inicio de sesión
        </a>
      </div>
    </div>
  </div>
</div>
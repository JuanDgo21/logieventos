<div class="recovery-container">
  <div class="card recovery-card">
    <div class="card-header">
      <h2 class="text-center">Recuperar Contraseña</h2>
    </div>
    
    <div class="card-body">
      @if (errorMessage) {
        <div class="alert alert-danger">
          {{ errorMessage }}
        </div>
      }

      @if (resetSuccess) {
        <div class="alert alert-success">
          Contraseña actualizada correctamente. Redirigiendo al login...
        </div>
      }

      <form [formGroup]="recoveryForm" (ngSubmit)="emailVerified ? resetPassword() : verifyEmail()">
        <!-- Email Input (Step 1) -->
        @if (!emailVerified) {
          <div class="mb-3">
            <label for="email" class="form-label">Correo Electrónico</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="fas fa-envelope"></i>
              </span>
              <input 
                type="email" 
                class="form-control" 
                id="email" 
                formControlName="email"
                placeholder="Ingresa tu correo electrónico"
                [ngClass]="{
                  'is-invalid': recoveryForm.get('email')?.invalid && 
                              (recoveryForm.get('email')?.dirty || recoveryForm.get('email')?.touched)
                }">
            </div>
            @if (recoveryForm.get('email')?.invalid && 
                (recoveryForm.get('email')?.dirty || recoveryForm.get('email')?.touched)) {
              <div class="invalid-feedback">
                @if (recoveryForm.get('email')?.errors?.['required']) {
                  <div>El correo electrónico es requerido</div>
                }
                @if (recoveryForm.get('email')?.errors?.['email']) {
                  <div>Ingresa un correo electrónico válido</div>
                }
              </div>
            }
          </div>
        }

        <!-- Password Reset (Step 2) -->
        @if (emailVerified && !resetSuccess) {
          <div class="reset-form">
            <div class="mb-3">
              <label for="newPassword" class="form-label">Nueva Contraseña</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-lock"></i>
                </span>
                <input 
                  type="password" 
                  class="form-control" 
                  id="newPassword" 
                  formControlName="newPassword"
                  placeholder="Ingresa tu nueva contraseña"
                  [ngClass]="{
                    'is-invalid': recoveryForm.get('newPassword')?.invalid && 
                                (recoveryForm.get('newPassword')?.dirty || recoveryForm.get('newPassword')?.touched)
                  }">
              </div>
              @if (recoveryForm.get('newPassword')?.invalid && 
                  (recoveryForm.get('newPassword')?.dirty || recoveryForm.get('newPassword')?.touched)) {
                <div class="invalid-feedback">
                  @if (recoveryForm.get('newPassword')?.errors?.['required']) {
                    <div>La contraseña es requerida</div>
                  }
                  @if (recoveryForm.get('newPassword')?.errors?.['minlength']) {
                    <div>La contraseña debe tener al menos 8 caracteres</div>
                  }
                </div>
              }
            </div>

            <div class="mb-3">
              <label for="confirmPassword" class="form-label">Confirmar Contraseña</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-lock"></i>
                </span>
                <input 
                  type="password" 
                  class="form-control" 
                  id="confirmPassword" 
                  formControlName="confirmPassword"
                  placeholder="Confirma tu nueva contraseña"
                  [ngClass]="{
                    'is-invalid': (recoveryForm.get('confirmPassword')?.invalid || 
                                  recoveryForm.errors?.['mismatch']) && 
                                 (recoveryForm.get('confirmPassword')?.dirty || 
                                  recoveryForm.get('confirmPassword')?.touched)
                  }">
              </div>
              @if (recoveryForm.errors?.['mismatch'] && 
                  (recoveryForm.get('confirmPassword')?.dirty || 
                   recoveryForm.get('confirmPassword')?.touched)) {
                <div class="invalid-feedback">
                  Las contraseñas no coinciden
                </div>
              }
            </div>
          </div>
        }

        @if (!resetSuccess) {
          <div class="d-grid gap-2">
            <button 
              type="submit" 
              class="btn btn-primary btn-lg"
              [disabled]="(emailVerified ? recoveryForm.invalid : recoveryForm.get('email')?.invalid) || isLoading">
              @if (!isLoading) {
                <i class="fas fa-paper-plane me-2"></i>
                {{ emailVerified ? 'Actualizar Contraseña' : 'Verificar Email' }}
              }
              @if (isLoading) {
                <i class="fas fa-spinner fa-spin me-2"></i>
                Procesando...
              }
            </button>
          </div>
        }
      </form>

      <div class="text-center mt-3">
        <a [routerLink]="['/auth/login']" class="text-decoration-none">
          <i class="fas fa-arrow-left me-2"></i>Volver al inicio de sesión
        </a>
      </div>
    </div>
  </div>
</div>
<app-navbar></app-navbar>
<app-sidebar></app-sidebar>
<div class="main-container">

  <div class="container-fluid py-4">
    <div *ngIf="isLoading" class="loading-overlay">
      <div class="spinner-grow text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-3">Cargando eventos...</p>
    </div>

    <div class="header-container">
      <h1 class="page-title">Gestión de Eventos</h1>
      <div class="d-flex gap-2">
        <button class="btn btn-secondary" routerLink="/pages/event-types">
            <i class="fas fa-tags me-2"></i>Tipos de Eventos
        </button>
        <button class="btn btn-primary new-event-btn" (click)="openModal('create')">
          <i class="fas fa-plus me-2"></i>Nuevo Evento
        </button>
      </div>
    </div>

    <div class="filters-container">
      <div class="search-filter">
        <i class="fas fa-search"></i>
        <input type="text" 
               [(ngModel)]="searchTerm" 
               (input)="applyFilters()"
               placeholder="Buscar eventos...">
      </div>
      
      <div class="filter-selectors">
        <select [(ngModel)]="selectedStatus" (change)="applyFilters()">
          <option value="all">Todos los estados</option>
          <option *ngFor="let status of statusOptions" [value]="status.value">
            {{status.label}}
          </option>
        </select>
        
        <select [(ngModel)]="selectedCategory" (change)="applyFilters()">
          <option value="all">Todos los tipos</option>
          <option *ngFor="let type of eventTypes" [value]="type._id">{{type.name}}</option>
        </select>
      </div>
    </div>

    <div *ngIf="!isLoading" class="events-grid">
      <div class="event-card" *ngFor="let event of filteredEvents">
        <div class="card-header">
          <h5 class="event-title">{{event.name}}</h5>
          <span class="event-status" [ngClass]="'status-' + event.status">
            <i [class]="getStatusIcon(event.status)"></i>
            {{getStatusLabel(event.status)}}
          </span>
        </div>
        
        <div class="card-body">
          <p class="event-description">{{event.description}}</p>
          
          <div class="event-details">
            <div class="detail-item">
              <i class="far fa-calendar-alt"></i>
              <span>Inicio: {{formatDisplayDate(event.startDate)}}</span>
            </div>
            
            <div class="detail-item">
              <i class="far fa-calendar-alt"></i>
              <span>Fin: {{formatDisplayDate(event.endDate)}}</span>
            </div>
            
            <div class="detail-item">
              <i class="fas fa-map-marker-alt"></i>
              <span>{{event.location}}</span>
            </div>
            
            <div class="detail-item" *ngIf="event.eventType">
              <i class="fas fa-tag"></i>
              <span>{{getCategoryName(event.eventType)}}</span>
            </div>
          </div>
        </div>
        
        <div class="card-actions">
          <button class="btn-action edit" (click)="openModal('edit', event)">
            <i class="far fa-edit"></i>
            <span>Editar</span>
          </button>
          <button class="btn-action delete" (click)="confirmDelete(event._id)">
            <i class="far fa-trash-alt"></i>
            <span>Eliminar</span>
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="!isLoading && filteredEvents.length === 0" class="empty-state">
      <i class="far fa-calendar-times"></i>
      <h4>No se encontraron eventos</h4>
      <p>No hay eventos que coincidan con tus criterios de búsqueda</p>
      <button class="btn btn-primary" (click)="openModal('create')">
        <i class="fas fa-plus me-2"></i>Crear nuevo evento
      </button>
    </div>

    <div class="modal fade" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i [class]="editingEvent ? 'far fa-edit me-2' : 'fas fa-plus me-2'"></i>
          {{editingEvent ? 'Editar Evento' : 'Nuevo Evento'}}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeModal()"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="eventForm">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Nombre del evento <span class="text-danger">*</span></label>
                <input type="text" class="form-control" formControlName="name">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Tipo de evento <span class="text-danger">*</span></label>
                <select class="form-select" formControlName="eventType">
                  <option [ngValue]="null" disabled>Seleccione un tipo</option>
                  <option *ngFor="let type of eventTypes" [value]="type._id">{{type.name}}</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="row g-3">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Contrato asociado <span class="text-danger">*</span></label>
                <select class="form-select" formControlName="contract">
                  <option [ngValue]="null" disabled>Seleccione un contrato</option>
                  <option *ngFor="let contract of contracts" [value]="contract._id">{{contract.name}}</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Responsable <span class="text-danger">*</span></label>
                <select class="form-select" formControlName="responsable">
                  <option [ngValue]="null" disabled>Seleccione un responsable</option>
                  <option *ngFor="let user of users" [value]="user._id">{{user.fullname}}</option>
                </select>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Descripción <span class="text-danger">*</span></label>
            <textarea class="form-control" 
                      formControlName="description" 
                      rows="3"
                      placeholder="Describe el evento..."></textarea>
            <div *ngIf="eventForm.get('description')?.invalid && eventForm.get('description')?.touched" 
                 class="text-danger mt-1" style="font-size: 0.875rem;">
              La descripción es obligatoria.
            </div>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Fecha de inicio <span class="text-danger">*</span></label>
                <input type="date" class="form-control" formControlName="startDate">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Fecha de fin <span class="text-danger">*</span></label>
                <input type="date" class="form-control" formControlName="endDate">
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-8">
              <div class="mb-3">
                <label class="form-label">Ubicación <span class="text-danger">*</span></label>
                <input type="text" class="form-control" formControlName="location">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Estado <span class="text-danger">*</span></label>
                <select class="form-select" formControlName="status">
                  <option *ngFor="let status of statusOptions" [value]="status.value">
                    {{status.label}}
                  </option>
                </select>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-top-0">
        <button type="button" class="btn btn-outline-secondary" (click)="closeModal()">
          <i class="fas fa-times me-1"></i> Cancelar
        </button>
        <button type="button" class="btn btn-primary" (click)="saveEvent()" [disabled]="eventForm.invalid">
          <i [class]="editingEvent ? 'fas fa-save me-1' : 'fas fa-check me-1'"></i>
          {{editingEvent ? 'Guardar cambios' : 'Crear evento'}}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'"></div>

</div>
<app-footer></app-footer>